@page "/festivals/modify"
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer

<PageTitle>Modify Festivals</PageTitle>

<Div Class="d-flex flex-column gap-3">
	<Card>
		<CardHeader>
			<h2>Add a new festival</h2>
		</CardHeader>
		<CardBody>
			<Container TextColor="TextColor.Primary">
				<Field>
					<Label Class="fs-5 text-dark">Festival name:</Label>
					<TextEdit @bind-Text="festival.Name" Placeholder="Festival name" />
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Festival description:</Label>
					<TextEdit @bind-Text="festival.Description" Placeholder="Festival description" />
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Festival location:</Label>
					<TextEdit @bind-Text="festival.Location" Placeholder="Festival location" />
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Festival start date:</Label>
					<DatePicker TValue="DateTime" @bind-Date="festival.StartDate" Inline/>
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Festival end date:</Label>
					<DatePicker TValue="DateTime" @bind-Date="festival.EndDate" Inline/>
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Bands playing:</Label>
					<Autocomplete TItem="ShowTime.Entities.Band"
								  TValue="Guid"
								  Data="@availableBands"
								  TextField="@(b => b.Name)"
								  ValueField="@(b => b.Id)"
								  Placeholder="Search..."
								  SelectionMode="AutocompleteSelectionMode.Multiple"
								  FreeTyping
								  MinLength="0"
								  OpenOnFocus="true"
								  CloseOnSelection="false"
								  @bind-SelectedValues="selectedBandIds"
								  @bind-SelectedTexts="selectedBandNames">
					</Autocomplete>

				</Field>

				<Button Color="Color.Success" Clicked="Submit">Add Festival</Button>
			</Container>
		</CardBody>
	</Card>

	<Card>
		<CardHeader>
			<h2>List of festivals</h2>
		</CardHeader>
		<CardBody>

			<Table>
				<thead>
					<tr>
						<th>Name</th>
						<th>Description</th>
						<th>Location</th>
						<th>Start Date</th>
						<th>End Date</th>
						<th>Bands Playing</th>
						<th>Action</th>
					</tr>
				</thead>
				<tbody>
					@foreach (Festival festival in festivals)
					{
						<tr>
							<td>@festival.Name</td>
							<td>@festival.Description</td>
							<td>@festival.Location</td>
							<td>@festival.StartDate</td>
							<td>@festival.EndDate</td>
							<td>
								@(
									festival.FestivalBands?.Any() != null
									? string.Join(" | ", festival.FestivalBands.Select(b => b.Band.Name))
									: "(none)"
								)
							</td>
							<td>
								<Button Color="Color.Danger" Text="Delete" Clicked="@(() => DeleteFestivalAction(festival))">Remove</Button>
								<Button Color="Color.Warning" Text="Edit" Clicked="@(() => EditFestivalAction(festival))">Edit</Button>
							</td>
						</tr>
					}
				</tbody>
			</Table>
		</CardBody>
	</Card>


	@if (triggerEditPopup)
	{
		<Div Class="popover popover-body" style="position: fixed;
														top: 5vh;
														left: 50%;
														transform: translateX(-50%);
														z-index: 1000;
														min-width: 50vw;">
			<h2>Edit</h2>


			<Container TextColor="TextColor.Primary">
				<Div Class="d-flex flex-row gap-3">

					<Field>
						<Label Class="fs-5 text-dark">Festival name:</Label>
						<TextEdit @bind-Text="festivalToBeEdited.Name" Placeholder="Festival name" />
					</Field>

					<Field>
						<Label Class="fs-5 text-dark">Festival description:</Label>
						<TextEdit @bind-Text="festivalToBeEdited.Description" Placeholder="Festival description" />
					</Field>
				</Div>

				<Div Class="d-flex flex-row gap-3">

				<Field>
					<Label Class="fs-5 text-dark">Festival location:</Label>
					<TextEdit @bind-Text="festivalToBeEdited.Location" Placeholder="Festival location" />
				</Field>

				<Field>
					<Label Class="fs-5 text-dark">Festival start date:</Label>
					<DatePicker TValue="DateTime" @bind-Date="festivalToBeEdited.StartDate" />
				</Field>


				<Field>
					<Label Class="fs-5 text-dark">Festival end date:</Label>
					<DatePicker TValue="DateTime" @bind-Date="festivalToBeEdited.EndDate" />
				</Field>
				</Div>

				<Field>
					<Label Class="fs-5 text-dark">Bands playing:</Label>
					<Autocomplete TItem="ShowTime.Entities.Band"
					TValue="Guid"
					Data="@availableBands"
					TextField="@(b => b.Name)"
					ValueField="@(b => b.Id)"
					Placeholder="Search..."
					SelectionMode="AutocompleteSelectionMode.Multiple"
					FreeTyping
					MinLength="0"
					OpenOnFocus="true"
					CloseOnSelection="false"
					@bind-SelectedValues="festivalToBeEditedSelectedBandIds"
					@bind-SelectedTexts="festivalToBeEditedSelectedBandNames">
					</Autocomplete>
				</Field>
			</Container>


			<Div Class="d-flex flex-row gap-2">
				<Button Color="Color.Success" Text="Save" Clicked="@(() => SaveEdit(festivalToBeEdited))">Save</Button>
				<Button Color="Color.Danger" Text="Close" Clicked="@(() => { triggerEditPopup = false; })">Close</Button>
			</Div>
		</Div>

	}

</Div>

<footer>
	<br />
	<br />
</footer>

@code {
	[Inject]
	private IRepositoryFestival RepositoryFestival { get; set; }
	[Inject]
	private IRepositoryBand RepositoryBand { get; set; }

	private List<ShowTime.Entities.Festival> festivals = new List<Festival>();
	private List<Band> availableBands = new List<Band>();
	private List<FestivalBand> availableFestivalBands = new List<FestivalBand>();
	protected override async Task OnInitializedAsync()
	{
		festivals = (await RepositoryFestival.GetAllWithBandsAsync()).ToList();

		availableBands = (await RepositoryBand.GetAllAsync()).ToList();
	}

	private List<Guid> selectedBandIds = new(); 
	private List<string> selectedBandNames = new();

	public Festival festival { get; set; } = new Festival()
	{
		Name = string.Empty,
		StartDate = DateTime.Today,
		EndDate = DateTime.Today,
		Description = string.Empty,
		Location = string.Empty
	};

	private async Task Submit()
	{
		if (String.IsNullOrWhiteSpace(festival.Name))
		{
			return;
		}

		try
		{

			if (string.IsNullOrWhiteSpace(festival.Name)) return;

			festival.Id = Guid.NewGuid();

			var uniqueSelectedBandIds = new HashSet<Guid>(selectedBandIds);

			festival.FestivalBands = uniqueSelectedBandIds
				.Select((bandId, idx) => new FestivalBand
				{
					FestivalId = festival.Id,
					BandId = bandId,
 				})
				.ToList();

			await RepositoryFestival.AddAsync(festival);
			await RepositoryFestival.SaveChangeAsync();
			festivals = (await RepositoryFestival.GetAllWithBandsAsync()).ToList();

			selectedBandIds.Clear();
			selectedBandNames.Clear();
			festival = new Festival
			{
				Name = string.Empty,
				StartDate = DateTime.Today,
				EndDate = DateTime.Today,
				Description = string.Empty,
				Location = string.Empty
			};
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error adding band: {ex.Message}");
		}
	}

	private async Task DeleteFestivalAction(Festival festival)
	{
		try
		{
			RepositoryFestival.Delete(festival);
			await RepositoryFestival.SaveChangeAsync();
			festivals = (await RepositoryFestival.GetAllWithBandsAsync()).ToList();
		}
		catch (Exception e)
		{
			Console.WriteLine($"Error deleting festival: {e.Message}");
		}
	}




	private bool triggerEditPopup = false;
	private Festival festivalToBeEdited = new Festival();
	private List<Guid> festivalToBeEditedSelectedBandIds = new();
	private List<string> festivalToBeEditedSelectedBandNames = new();
	private async Task EditFestivalAction(Festival festival)
	{
		festivalToBeEdited = new Festival
		{
			Id = festival.Id,
			Name = festival.Name,
			Description = festival.Description,
			Location = festival.Location,
			StartDate = festival.StartDate,
			EndDate = festival.EndDate,
		};
		festivalToBeEditedSelectedBandIds = festival.FestivalBands?.Select(fb => fb.Band.Id).ToList() ?? new List<Guid>();
		festivalToBeEditedSelectedBandNames = festival.FestivalBands?.Select(fb => fb.Band.Name).ToList() ?? new List<string>();

		triggerEditPopup = true;
	}

	private async Task SaveEdit(Festival festival)
	{
		try
		{
			var original = await RepositoryFestival.GetByIdAsync(festivalToBeEdited.Id);
			if (original is null)
				throw new Exception("Festival not found");
			original.Name = festivalToBeEdited.Name;
			original.Description = festivalToBeEdited.Description;
			original.Location = festivalToBeEdited.Location;
			original.StartDate = festivalToBeEdited.StartDate;
			original.EndDate = festivalToBeEdited.EndDate;
			//original.Bands = availableBands.Where(b => festivalToBeEditedSelectedBandIds.Contains(b.Id)).ToList();
			
			original.FestivalBands = festivalToBeEditedSelectedBandIds
				.Select((bandId, idx) => new FestivalBand
				{
					FestivalId = original.Id,
					BandId = bandId,
				})
				.ToList();
			
			await RepositoryFestival.SaveChangeAsync();
			festivals = (await RepositoryFestival.GetAllWithBandsAsync()).ToList();
			triggerEditPopup = false;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error saving festival: {ex.Message}");
		}
	}
}